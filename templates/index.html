{% extends "base.html" %}
{% load static %}

{% block title %}URL 분석 - Link Shield{% endblock %}

{% block content %}
<div class="hero-section">
    <h1 class="hero-title">URL 보안 분석</h1>
    <p class="hero-subtitle">의심스러운 링크를 안전하게 분석합니다</p>
</div>

<div class="card main-card">
    <form id="analysisForm" class="analysis-form">
        {% csrf_token %}

        <div class="form-group">
            <label for="url" class="form-label">
                <span class="label-icon">🔗</span>
                분석할 URL을 입력하세요
            </label>
            <input
                type="url"
                id="url"
                name="url"
                class="form-input"
                placeholder="https://example.com"
                required
                autocomplete="off"
            >
            <div class="input-hint">※ http:// 또는 https://를 포함한 전체 URL을 입력해주세요</div>
        </div>

        <button type="submit" class="submit-btn">
            <span class="btn-icon">🔍</span>
            <span>지금 분석하기</span>
            <span class="btn-arrow">→</span>
        </button>
    </form>
</div>

<div class="info-grid">
    <div class="info-card">
        <div class="info-icon">📸</div>
        <h3>스크린샷</h3>
        <p>페이지를 안전하게 렌더링하여 미리보기를 제공합니다</p>
    </div>

    <div class="info-card">
        <div class="info-icon">🔄</div>
        <h3>리다이렉션</h3>
        <p>모든 리다이렉션 경로를 추적하여 최종 도착지를 확인합니다</p>
    </div>

    <div class="info-card">
        <div class="info-icon">⚡</div>
        <h3>동적 분석</h3>
        <p>JavaScript 실행과 네트워크 활동을 모니터링합니다</p>
    </div>

    <div class="info-card">
        <div class="info-icon">🌐</div>
        <h3>서버 분석</h3>
        <p>호스트 서버의 정보와 공개 포트를 확인합니다</p>
    </div>
</div>

<!-- 샘플 URL 섹션 -->
<div class="samples-section">
    <h2 class="samples-title">📌 샘플 URL 둘러보기</h2>
    <p class="samples-subtitle">클릭하면 자동으로 입력됩니다</p>

    <div class="samples-grid">
        <!-- 박스 1: A예시 (하드코딩) -->
        <div class="sample-box">
            <div class="sample-header">
                <h3>🔵 A예시</h3>
                <span class="sample-badge">일반 웹사이트</span>
            </div>
            <div class="sample-list">
                <button type="button" class="sample-item" onclick="fillURL('https://www.google.com')">
                    <span class="sample-icon">🌐</span>
                    <span class="sample-url">google.com</span>
                </button>
                <button type="button" class="sample-item" onclick="fillURL('https://www.naver.com')">
                    <span class="sample-icon">🌐</span>
                    <span class="sample-url">naver.com</span>
                </button>
                <button type="button" class="sample-item" onclick="fillURL('https://www.youtube.com')">
                    <span class="sample-icon">🎥</span>
                    <span class="sample-url">youtube.com</span>
                </button>
                <button type="button" class="sample-item" onclick="fillURL('https://github.com')">
                    <span class="sample-icon">💻</span>
                    <span class="sample-url">github.com</span>
                </button>
                <button type="button" class="sample-item" onclick="fillURL('https://www.amazon.com')">
                    <span class="sample-icon">🛒</span>
                    <span class="sample-url">amazon.com</span>
                </button>
                <button type="button" class="sample-item" onclick="fillURL('https://stackoverflow.com')">
                    <span class="sample-icon">💡</span>
                    <span class="sample-url">stackoverflow.com</span>
                </button>
                <button type="button" class="sample-item" onclick="fillURL('https://www.wikipedia.org')">
                    <span class="sample-icon">📚</span>
                    <span class="sample-url">wikipedia.org</span>
                </button>
                <button type="button" class="sample-item" onclick="fillURL('https://www.reddit.com')">
                    <span class="sample-icon">💬</span>
                    <span class="sample-url">reddit.com</span>
                </button>
                <button type="button" class="sample-item" onclick="fillURL('https://www.twitter.com')">
                    <span class="sample-icon">🐦</span>
                    <span class="sample-url">twitter.com</span>
                </button>
                <button type="button" class="sample-item" onclick="fillURL('https://www.linkedin.com')">
                    <span class="sample-icon">💼</span>
                    <span class="sample-url">linkedin.com</span>
                </button>
            </div>
        </div>

        <!-- 박스 2: B예시 (API 연동 준비) -->
        <div class="sample-box">
            <div class="sample-header">
                <h3>🟢 B예시</h3>
                <span class="sample-badge">API 연동 예정</span>
            </div>
            <div class="sample-list" id="sampleBoxB">
                <div class="sample-placeholder">
                    <span class="placeholder-icon">🔄</span>
                    <p>API 연동 후 샘플이 표시됩니다</p>
                </div>
            </div>
        </div>

        <!-- 박스 3: C예시 (API 연동 준비) -->
        <div class="sample-box">
            <div class="sample-header">
                <h3>🟡 C예시</h3>
                <span class="sample-badge">API 연동 예정</span>
            </div>
            <div class="sample-list" id="sampleBoxC">
                <div class="sample-placeholder">
                    <span class="placeholder-icon">🔄</span>
                    <p>API 연동 후 샘플이 표시됩니다</p>
                </div>
            </div>
        </div>

        <!-- 박스 4: 최근 분석 URL (DB 연동) -->
        <div class="sample-box">
            <div class="sample-header">
                <h3>🟣 최근 분석 URL</h3>
                <span class="sample-badge">최신 10개</span>
            </div>
            <div class="sample-list" id="recentURLs">
                {% if recent_urls %}
                    {% for item in recent_urls %}
                    <button type="button" class="sample-item" onclick="fillURL('{{ item.original_url }}')">
                        <span class="sample-icon">
                            <img src="https://www.google.com/s2/favicons?domain={{ item.domain }}&sz=32"
                                 alt="icon"
                                 style="width: 18px; height: 18px;"
                                 onerror="this.style.display='none'; this.parentElement.textContent='🌐';">
                        </span>
                        <span class="sample-url">{{ item.domain }}</span>
                    </button>
                    {% endfor %}
                {% else %}
                    <div class="sample-placeholder">
                        <span class="placeholder-icon">💾</span>
                        <p>분석 기록이 없습니다</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="warning-box">
    <div class="warning-icon">⚠️</div>
    <div class="warning-content">
        <h4>주의사항</h4>
        <p>본 서비스는 교육 목적의 포트폴리오 프로젝트입니다. 실제 보안 위협을 100% 탐지하지 못할 수 있습니다.</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// CSRF 토큰 가져오기
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// URL 입력 필드에 자동 입력 함수
function fillURL(url) {
    const urlInput = document.getElementById('url');
    urlInput.value = url;

    urlInput.scrollIntoView({ behavior: 'smooth', block: 'center' });

    urlInput.style.transition = 'all 0.3s ease';
    urlInput.style.borderColor = '#667eea';
    urlInput.style.boxShadow = '0 0 0 4px rgba(102, 126, 234, 0.2)';

    setTimeout(() => {
        urlInput.style.borderColor = '';
        urlInput.style.boxShadow = '';
    }, 1500);
}

// 폼 제출 처리 (API 호출)
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('analysisForm');
    const submitBtn = form.querySelector('.submit-btn');
    const urlInput = document.getElementById('url');

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const url = urlInput.value.trim();

        if (!url) {
            alert('URL을 입력해주세요.');
            return;
        }

        // 로딩 상태
        const originalHTML = submitBtn.innerHTML;
        submitBtn.innerHTML = '<span class="spinner"></span><span>분석 중...</span>';
        submitBtn.disabled = true;

        try {
            // API 호출
            const response = await fetch('/api/analyze/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({ url: url })
            });

            const data = await response.json();

            if (response.ok) {
                // 성공: 결과 페이지로 이동
                window.location.href = `/result/${data.id}/`;
            } else {
                // 에러 처리
                alert('분석 중 오류가 발생했습니다: ' + (data.error || '알 수 없는 오류'));
                submitBtn.innerHTML = originalHTML;
                submitBtn.disabled = false;
            }
        } catch (error) {
            console.error('Error:', error);
            alert('네트워크 오류가 발생했습니다. 다시 시도해주세요.');
            submitBtn.innerHTML = originalHTML;
            submitBtn.disabled = false;
        }
    });

    // 파비콘 적용
    const sampleItems = document.querySelectorAll('.sample-item');
    sampleItems.forEach(item => {
        const urlText = item.querySelector('.sample-url')?.textContent;
        const iconElement = item.querySelector('.sample-icon');

        if (urlText && iconElement && !iconElement.querySelector('img')) {
            const faviconUrl = `https://www.google.com/s2/favicons?domain=${urlText}&sz=32`;
            iconElement.innerHTML = `<img src="${faviconUrl}" alt="icon" style="width: 18px; height: 18px;" onerror="this.style.display='none'; this.parentElement.textContent='🌐';">`;
        }
    });
});
</script>
{% endblock %}